#!/bin/bash

cd /home/wka/code/izhbet

source venv/bin/activate

echo "=========================================="
echo "üöÄ –ó–ê–ü–£–°–ö –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–ù–û–ì–û –ü–ê–ô–ü–õ–ê–ô–ù–ê"
echo "=========================================="

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
mysql --host=$DATABASE_HOST --user=$DATABASE_USER --password=$DATABASE_PASSWORD --max_allowed_packet=1073741824 -e "SET GLOBAL FOREIGN_KEY_CHECKS = 0;"

if [ $? -eq 0 ]; then
    echo "‚úÖ FOREIGN_KEY_CHECKS —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ FOREIGN_KEY_CHECKS..."
fi

echo ""
echo "üìä –≠–¢–ê–ü 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å —Å–∞–π—Ç–∞ stat-api.baltbet.ru"
echo "=================================================="
python3.12 getting.py UPDATE_DB -Wignore
if [ $? -ne 0 ]; then
    echo "‚ùå –ü—Ä–æ–≥—Ä–∞–º–º–∞: getting.py - –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π" >&2
    exit $?
fi
echo "‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î"

echo ""
echo "üßÆ –≠–¢–ê–ü 2: –†–∞—Å—á–µ—Ç —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã"
echo "=============================================="
python3.12 calculation.py LATELY -Wignore
if [ $? -ne 0 ]; then
    echo "‚ùå –ü—Ä–æ–≥—Ä–∞–º–º–∞: calculation.py - –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π" >&2
    exit $?
fi
echo "‚úÖ –¢—É—Ä–Ω–∏—Ä–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ snapshots —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã"

echo ""
echo "üéØ –≠–¢–ê–ü 3-5: –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–ù–´–ô –ü–ê–ô–ü–õ–ê–ô–ù"
echo "====================================="
echo "  üîß Processing ‚Üí Forecast ‚Üí Publisher"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω
python3.12 run_pipeline.py today --verbose
if [ $? -ne 0 ]; then
    echo "‚ùå –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π" >&2
    exit $?
fi

echo ""
echo "=========================================="
echo "üéâ –ò–ù–¢–ï–ì–†–ò–†–û–í–ê–ù–ù–´–ô –ü–ê–ô–ü–õ–ê–ô–ù –ó–ê–í–ï–†–®–ï–ù!"
echo "=========================================="
echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
echo "  ‚Ä¢ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã"
echo "  ‚Ä¢ –¢—É—Ä–Ω–∏—Ä–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã"
echo "  ‚Ä¢ –ú–æ–¥–µ–ª–∏ –æ–±—É—á–µ–Ω—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã —Å–æ–∑–¥–∞–Ω—ã"
echo "  ‚Ä¢ –ö–æ–Ω—Ñ–æ—Ä–º–Ω–æ–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ"
echo "  ‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã –æ—Ç–æ–±—Ä–∞–Ω—ã"
echo "  ‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã"
echo "=========================================="

deactivate
