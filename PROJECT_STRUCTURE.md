# IZHBET - Система прогнозирования спортивных событий

## Обзор проекта

IZHBET — это комплексная система машинного обучения для прогнозирования исходов спортивных матчей (футбол, хоккей). Система использует глубокие нейронные сети, конформное прогнозирование и многопроцессорную обработку данных для создания точных прогнозов с интервалами неопределенности.

## Архитектура системы

Система построена по модульному принципу с четким разделением ответственности:

```
izhbet/
├── getting/          # Сбор данных с API
├── calculation/      # Расчет турнирных таблиц и статистики
├── processing/       # Обучение моделей и прогнозирование
├── forecast/         # Генерация конформных прогнозов
├── publisher/        # Публикация результатов
├── core/            # Общие компоненты и утилиты
├── db/              # Работа с базой данных
└── monitoring/      # Мониторинг качества
```

## Основные модули

### 1. Getting (Сбор данных)
**Файлы:** `getting.py`, `getting/`

**Назначение:** Получение данных о спортивных событиях с API stat-api.baltbet.ru

**Ключевые компоненты:**
- `datahandler.py` — обработка и валидация данных
- `download.py` — загрузка данных с API
- Многопроцессорная обработка через `core/consumer.py`

**Паттерны:** Factory Method, Template Method, Strategy

### 2. Calculation (Расчет статистики)
**Файлы:** `calculation.py`, `calculation/`

**Назначение:** Расчет турнирных таблиц, рейтингов команд и статистических показателей

**Ключевые компоненты:**
- `standings.py` — расчет рейтингов (DIF, VO, ELO, Потёмкин, Power)
- `tournament.py` — pipeline обработки турниров
- Поддержка различных стратегий расчета

**Паттерны:** Pipeline, Singleton, Strategy, Observer

### 3. Processing (Обучение и прогнозирование)
**Файлы:** `processing.py`, `processing/`

**Назначение:** Создание и обучение нейронных сетей, генерация прогнозов

**Ключевые компоненты:**
- `pipeline.py` — основной pipeline обработки
- `conformal_predictor.py` — конформное прогнозирование
- `keras_manager.py` — управление Keras моделями
- `neural_conformal.py` — нейронные конформные предикторы

**Действия:**
- `CREATE_MODEL` — создание модели
- `CREATE_PROGNOZ` — генерация прогнозов

### 4. Forecast (Конформные прогнозы)
**Файлы:** `forecast.py`, `forecast/`

**Назначение:** Генерация конформных прогнозов с интервалами неопределенности

**Ключевые компоненты:**
- `conformal_publication.py` — генератор конформных прогнозов
- `forecast.py` — утилиты форматирования прогнозов

**CLI команды:**
- `today` — прогнозы на сегодня + итоги вчера
- `quality-outcomes --date YYYY-MM-DD` — качественные итоги
- `season --year 2025` — обработка сезона
- `date --tournament-id ID --match-date YYYY-MM-DD` — по дате и чемпионату

### 5. Publisher (Публикация)
**Файлы:** `publisher.py`, `publisher/`

**Назначение:** Публикация прогнозов в различные каналы

**Поддерживаемые каналы:**
- Telegram
- VK
- Файловый вывод

**Паттерны:** Factory Method, Observer, Strategy, Chain of Responsibility

## Вспомогательные модули

### Core (Общие компоненты)
**Файлы:** `core/`

**Назначение:** Общие утилиты и компоненты

**Ключевые файлы:**
- `constants.py` — константы проекта
- `consumer.py` — многопроцессорная обработка
- `feature_engineer.py` — инженерия признаков
- `evaluation.py` — оценка качества моделей
- `types.py` — типы данных

### Database (Работа с БД)
**Файлы:** `db/`

**Структура:**
- `models/` — ORM модели SQLAlchemy
- `queries/` — запросы к БД
- `storage/` — сохранение данных

### Monitoring (Мониторинг)
**Файлы:** `monitoring/`

**Назначение:** Мониторинг качества прогнозов и системы

## Технологический стек

### Основные библиотеки
- **Python 3.12** — основной язык
- **SQLAlchemy** — ORM для работы с БД
- **Pandas** — обработка данных
- **NumPy** — численные вычисления
- **Scikit-learn** — машинное обучение
- **Keras/TensorFlow** — нейронные сети
- **Multiprocessing** — параллельная обработка

### База данных
- **MySQL** — основная БД
- **Alembic** — миграции схемы БД

### Дополнительные инструменты
- **Docker** — контейнеризация
- **pytest** — тестирование
- **Logging** — система логирования

## Запуск системы

### Основной pipeline
```bash
./run.sh
```

### Отдельные модули
```bash
# Сбор данных
python3.12 getting.py UPDATE_DB

# Расчет статистики
python3.12 calculation.py LATELY

# Обучение и прогнозы
python3.12 processing.py CREATE_PROGNOZ

# Конформные прогнозы
python3.12 forecast.py today

# Публикация
python3.12 publisher.py TODAY
```

## Конфигурация

### Основные файлы
- `config.py` — настройки подключения к БД
- `requirements.txt` — зависимости Python
- `alembic.ini` — настройки миграций

### Переменные окружения
- `DATABASE_HOST` — хост БД
- `DATABASE_USER` — пользователь БД
- `DATABASE_PASSWORD` — пароль БД
- `DATABASE_NAME` — имя БД

## Структура данных

### Основные таблицы
- `matchs` — матчи
- `teams` — команды
- `tournaments` — турниры
- `standings` — турнирные таблицы
- `features` — признаки для ML
- `predictions` — прогнозы
- `outcomes` — конформные прогнозы

### Типы прогнозов
- `win_draw_loss` — исход матча (П1/Х/П2)
- `oz` — обе забьют (да/нет)
- `goal_home/away` — забьет ли команда
- `total` — тотал больше/меньше
- `total_amount` — точное количество голов

## Паттерны проектирования

### Архитектурные паттерны
- **Pipeline** — последовательная обработка данных
- **Factory Method** — создание объектов
- **Strategy** — различные алгоритмы расчета
- **Observer** — уведомления об изменениях

### Паттерны обработки данных
- **Template Method** — шаблоны обработки
- **Chain of Responsibility** — цепочка фильтров
- **Singleton** — глобальные объекты

## Многопроцессорность

Система активно использует `multiprocessing` для:
- Параллельной обработки турниров
- Одновременного обучения моделей
- Параллельной загрузки данных
- Многопоточной публикации

## Качество кода

### Стандарты
- **PEP8** — стиль кода Python
- **Type hints** — аннотации типов
- **Docstrings** — документация функций
- **Logging** — структурированное логирование

### Тестирование
- **pytest** — фреймворк тестирования
- **Unit tests** — модульные тесты
- **Integration tests** — интеграционные тесты

## Мониторинг и логирование

### Логирование
- Структурированные логи
- Различные уровни (INFO, WARNING, ERROR)
- Ротация логов

### Мониторинг качества
- Точность прогнозов
- Производительность системы
- Качество данных

## Расширение системы

### Добавление новых типов прогнозов
1. Обновить `core/constants.py`
2. Добавить логику в `processing/`
3. Обновить `forecast/` и `publisher/`

### Добавление новых каналов публикации
1. Создать класс в `publisher/`
2. Реализовать интерфейс публикации
3. Зарегистрировать в фабрике

### Добавление новых стратегий расчета
1. Наследовать от базового класса в `calculation/`
2. Реализовать методы расчета
3. Зарегистрировать в pipeline

## Производительность

### Оптимизации
- Многопроцессорная обработка
- Индексы БД
- Кэширование моделей
- Batch обработка

### Масштабирование
- Горизонтальное масштабирование через multiprocessing
- Вертикальное масштабирование через оптимизацию алгоритмов
- Кэширование промежуточных результатов

## Безопасность

### Защита данных
- Безопасное подключение к БД
- Валидация входных данных
- Обработка ошибок

### Конфиденциальность
- Логирование без чувствительных данных
- Безопасное хранение паролей

## Документация

### Техническая документация
- README файлы в каждом модуле
- Docstrings в коде
- Диаграммы архитектуры

### Пользовательская документация
- Инструкции по запуску
- Примеры использования
- Troubleshooting

## Заключение

IZHBET представляет собой современную, масштабируемую систему прогнозирования спортивных событий, построенную с использованием лучших практик разработки и современных технологий машинного обучения. Модульная архитектура позволяет легко расширять и модифицировать систему под новые требования.
