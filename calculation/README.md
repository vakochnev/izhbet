# Модуль расчета турнирной таблицы

    Этот модуль предназначен для расчета турнирных таблиц и векторов матчей для спортивных лиг, таких как футбол и хоккей. Он поддерживает различные стратегии расчета рейтингов и статистики команд.
    Это программное обеспечение предназначено для анализа спортивных матчей и создания статистических данных для последующего использования в машинном обучении.


## Основные возможности

    - **Паттерны проектирования**: Реализованы паттерны Singleton, Strategy и Pipeline для обеспечения модульности и масштабируемости.
    - **Системы рейтингов**: Поддержка нескольких систем рейтингов (DIF, VO, ELO, "Потёмкин", Power) для комплексного анализа.
    - **Оптимизация**: Используется библиотека `multiprocessing` для параллельной обработки турниров, что значительно улучшает производительность.
    - **Соответствие PEP8**: Код полностью соответствует стандарту Python PEP8 для удобства чтения и поддержки.
    - **Документация**: Исчерпывающая документация с docstrings для всех классов и методов.

## Структура каталога

    calculation/
    ├── calculation.py # Точка входа в модуль
    ├── standings.py # Логика расчета статистики команд и рейтингов
    ├── tournament.py # Реализация конвейера данных и многопроцессорной обработки
    └── README.md # Это файл

#Архитектура системы
##Система построена по принципу pipeline и состоит из следующих компонентов:

    Источник данных (DatabaseSource) - извлекает данные из базы данных.
    Процессор данных (CreatingStandings) - обрабатывает данные и создает статистику.
    Хранилище данных (FileStorage) - сохраняет результаты обработки.

##Паттерны проектирования

    Pipeline - основной архитектурный паттерн, позволяющий разделить процесс обработки данных на этапы.
    Singleton - используется в классе Tournament для обеспечения глобального доступа к данным турнира.
    Strategy - применяется для реализации различных способов расчета рейтингов и турнирных таблиц.
    Observer - используется для отслеживания изменений в данных о матчах и командах.

##Алгоритмы расчета
    
    Рейтинги команд
    DIF-рейтинг : основан на разнице голов и решении системы линейных уравнений.
    VO-рейтинг : взвешенная сумма очков соперников.
    ЭЛО-рейтинг : адаптация известного рейтинга для спортивных матчей.
    "Потёмкин-рейтинг" : имитация экономической модели.
    Рейтинг силы : основывается на предопределенной таблице значений.

##Статистика матчей
    
    Тоталы (TB/TM) : количество матчей с тоталом больше/меньше определенного значения.
    Индивидуальные тоталы (ITB/ITM) : аналогично для индивидуальных показателей.
    Обе забили (OZ/OZN) : количество матчей, где обе команды забили/не забили.
    Сухие матчи : победы и поражения без пропущенных/забитых голов.

##Особенности применения

    Параллельная обработка

    Основное узкое место в исходном коде - последовательная обработка матчей. 
    В рефакторинге мы внедрили параллельную обработку матчей с использованием библиотеки multiprocessing. 
    Это позволяет значительно ускорить обработку больших объемов данных.

##Запуск модуля
    
    python calculation.py full

###Основные классы и методы

####calculation.py

    main() : Точка входа в модуль. Инициализирует и запускает конвейер данных.
    get_time_frame() : Получает временной диапазон из аргументов командной строки или использует значение по умолчанию.
    
####standings.py

    Tournament : Паттерн Singleton для управления состоянием турнира.
    add_team(team_name) : Добавляет новую команду в турнир.
    add_match(...) : Добавляет матч в турнир и обновляет статистику команд.
    calculate_ratings(table_strategy) : Рассчитывает рейтинги команд с использованием выбранной стратегии.
    RatingStrategy : Абстрактный класс для стратегий расчета рейтингов.
    DIFRatingStrategy : Реализация расчета DIF-рейтинга.
    VORatingStrategy : Реализация расчета VO-рейтинга.
    ELORatingStrategy : Реализация классической системы рейтингов ELO.
    PotemkinRatingStrategy : Реализация "Потёмкинского" рейтинга.
    PowerRatingStrategy : Реализация рейтинга силы.

    Team : Представляет команду с подробной статистикой и историей матчей.
    update_stats(...) : Обновляет статистику команды на основе результатов матча.

    Match : Представляет матч между двумя командами и обновляет их статистику.

####tournament.py

    CalculationDataPipeline : Реализация паттерна Pipeline для обработки данных турнира.
    process_data(time_frame) : Координирует процесс обработки данных.
    DatabaseSource : Извлекает данные из базы данных.
    CreatingStandings : Обрабатывает данные для расчета турнирных таблиц и векторов матчей.
    FileStorage : Сохраняет обработанные данные в хранилище.

###Стратегии расчета рейтингов

    Модуль поддерживает несколько стратегий расчета рейтингов, каждая из которых имеет свою логику:

    DIF-Рейтинг : Основан на разнице голов в проигранных матчах.
    VO-Рейтинг : Взвешенная система очков с учетом силы соперников.
    ELO-Рейтинг : Классическая система ELO с корректировками для домашних преимуществ и силы соперников.
    "Потёмкинский" рейтинг : Симулирует систему ставок, где команды "ставят" часть своего рейтинга.
    Рейтинг силы : Оценивает силу команды на основе результатов матчей.
    Оптимизация с помощью multiprocessing
    Модуль использует библиотеку multiprocessing для параллельной обработки турниров. Каждый турнир обрабатывается независимо, что позволяет эффективно использовать многоядерные процессоры.

##Конфигурация

    Система использует следующие конфигурационные файлы:

    config.py - содержит настройки подключения к базе данных.
    core/constants.py - содержит предопределенные константы, такие как временные рамки и параметры расчета.
    core/utils.py - содержит вспомогательные функции для конвертации данных.

##Использование

    Установите зависимости:

    pip install pandas sqlalchemy
    Настройте конфигурацию в config.py.
    Запустите основной скрипт:

    python calculation.py [time_frame]
    где time_frame может быть:
    all - для обработки данных за все время
    current - для обработки данных за текущий сезон (по умолчанию)

##Расширение

    Система легко расширяема благодаря использованию паттерна Strategy. 
    Для добавления новой стратегии расчета турнирной таблицы:

    Создайте новый класс, наследующийся от TableStrategy.
    Реализуйте метод filter_matches для определения правил фильтрации матчей.
    Добавьте класс в список strategies в tournament.py.
    Пример добавления стратегии расчета статистики для матчей против команд из определенного региона:

    python
    
    class RegionalOpponentsTableStrategy(TableStrategy):
        def __init__(self, region):
            self.region = region
        
        def filter_matches(self, teams):
            regional_teams = [
                team for team in teams.values()
                if team.region == self.region
            ]
            
            for team in teams.values():
                team.filtered_matches = [
                    match for match in team.matches
                    if match[4] in regional_teams
                ]
##Логгирование
    
    Система использует стандартное логгирование Python. 
    Уровень логгирования можно настроить в начале каждого файла или в центральном конфигурационном файле.

##Тестирование
    
    Для тестирования системы рекомендуется использовать pytest. Пример теста для проверки корректности расчета ЭЛО-рейтинга:

    import pytest
    from standings import Team, ELORatingStrategy
    
    def test_elo_rating():
        # Создаем две команды
        team1 = Team("Team A")
        team2 = Team("Team B")
        
        # Устанавливаем начальные рейтинги
        team1.elo_rating = 1600
        team2.elo_rating = 1400
        
        # Создаем матч и обновляем статистику
        match_data = (3, 1, 'win', True, team2, 1, datetime.now())
        team1.matches = [match_data]
        
        # Рассчитываем рейтинг
        strategy = ELORatingStrategy()
        strategy.calculate_ratings([team1])
        
        # Проверяем, что рейтинг обновился корректно
        assert team1.elo_rating > 1600  # Рейтинг должен увеличиться
        assert team2.elo_rating < 1400  # Рейтинг должен уменьшиться

##Заключение
    
    Эта система предоставляет гибкую и расширяемую архитектуру для анализа спортивных матчей и создания статистических данных. 

##Как запускать тесты
    
    После того как вы положили тесты по правильным местам, выполните в терминале:

    bash
    pytest
    pytest tests/test_standings.py
    pytest tests/test_standings.py::test_team_initialization

##Рекомендации по использованию pytest

    Используйте фикстуры (@pytest.fixture) для повторного использования объектов.
    Разбивайте тесты на логические группы (например, один тестовый класс на один тестируемый класс).
    Добавьте покрытие тестами всех основных методов и краевых случаев.
    Используйте pytest-cov для анализа покрытия:
    
    pytest --cov=.

##Заключение
    
    Размещение тестов в отдельной директории tests/ с четкой структурой позволяет легко поддерживать проект, быстро находить нужные тесты и интегрировать систему с CI/CD. 
    Такой подход соответствует лучшим практикам Python и рекомендациям pytest.
