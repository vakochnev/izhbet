# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ publisher.py TODAY

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞

`publisher.py TODAY` –≤—ã–ø–æ–ª–Ω—è–ª—Å—è **12 –º–∏–Ω—É—Ç**, —Ö–æ—Ç—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∑–∞ 1 –¥–µ–Ω—å.

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```
publisher.py TODAY
  ‚Üì
  get_matches_for_date(today)       # 90 –º–∞—Ç—á–µ–π
  get_matches_for_date(yesterday)   # 80 –º–∞—Ç—á–µ–π
  ‚Üì
  –î–ª—è –ö–ê–ñ–î–û–ì–û –º–∞—Ç—á–∞ (170 –º–∞—Ç—á–µ–π):
    ‚Üì
    get_outcomes_for_match(match_id)       # SQL –∑–∞–ø—Ä–æ—Å
    get_statistics_for_match(match_id)     # SQL –∑–∞–ø—Ä–æ—Å
    ‚Üì
    –î–ª—è –ö–ê–ñ–î–û–ì–û –ø—Ä–æ–≥–Ω–æ–∑–∞ (~10 –ø—Ä–æ–≥–Ω–æ–∑–æ–≤):
      ‚Üì
      get_complete_statistics(type, subtype)  # 0.86 —Å–µ–∫—É–Ω–¥—ã!
        ‚Üì –í–Ω—É—Ç—Ä–∏:
        - get_historical_accuracy_regular()   # SQL –∑–∞–ø—Ä–æ—Å
        - get_recent_accuracy()                # SQL –∑–∞–ø—Ä–æ—Å
        - get_calibration()                    # SQL –∑–∞–ø—Ä–æ—Å
        - get_stability()                      # SQL –∑–∞–ø—Ä–æ—Å
        - get_confidence_bounds()              # SQL –∑–∞–ø—Ä–æ—Å
```

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤

- **170 –º–∞—Ç—á–µ–π** √ó **10 –ø—Ä–æ–≥–Ω–æ–∑–æ–≤** √ó **0.86—Å** = **1462 —Å–µ–∫—É–Ω–¥—ã** ‚âà **24 –º–∏–Ω—É—Ç—ã**

### –ë–µ–Ω—á–º–∞—Ä–∫

```bash
$ python3 -c "from db.queries.statistics_metrics import get_complete_statistics; ..."

get_complete_statistics: 1.07—Å
10 –≤—ã–∑–æ–≤–æ–≤: 8.60—Å (0.860—Å –∫–∞–∂–¥—ã–π)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ `get_complete_statistics()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç 5 SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∑–∞–Ω–∏–º–∞–µ—Ç ~0.86 —Å–µ–∫—É–Ω–¥—ã.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### LRU –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω –º–æ–¥—É–ª—å `db/queries/statistics_cache.py` —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π `get_complete_statistics_cached()`:

```python
from functools import lru_cache

@lru_cache(maxsize=1024)
def get_complete_statistics_cached(
    forecast_type: str,
    forecast_subtype: str,
    championship_id: Optional[int] = None,
    sport_id: Optional[int] = None
) -> Dict[str, Any]:
    """
    –ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è get_complete_statistics.
    
    –ö–µ—à —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    –î–ª—è –¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ clear_statistics_cache().
    """
    # ... –≤—ã–∑–æ–≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
```

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç LRU –∫–µ—à

**LRU (Least Recently Used)** ‚Äî –∫–µ—à–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π:
- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: –≤—ã–ø–æ–ª–Ω—è–µ—Ç SQL –∑–∞–ø—Ä–æ—Å—ã, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤—ã–∑–æ–≤—ã —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑ –∫–µ—à–∞ (0.0001—Å –≤–º–µ—Å—Ç–æ 0.86—Å)
- `maxsize=1024` ‚Äî —Ö—Ä–∞–Ω–∏—Ç –¥–æ 1024 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `publisher/statistics_publisher.py`

```python
# –ë–´–õ–û:
from db.queries.statistics_metrics import get_complete_statistics

# –°–¢–ê–õ–û:
from db.queries.statistics_cache import (
    get_complete_statistics_cached as get_complete_statistics,
    clear_statistics_cache,
    get_cache_info
)
```

**–§–∞–π–ª:** `publisher/formatters/forecast_formatter.py`

```python
# –ë–´–õ–û:
from db.queries.statistics_metrics import get_complete_statistics

# –°–¢–ê–õ–û:
from db.queries.statistics_cache import get_complete_statistics_cached as get_complete_statistics
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–µ—à–∞

–í –∫–æ–Ω—Ü–µ `publish_today_forecasts_and_outcomes()` –¥–æ–±–∞–≤–ª–µ–Ω–æ:

```python
cache_info = get_cache_info()
logger.info(f'–ö–µ—à —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {cache_info["hits"]} –ø–æ–ø–∞–¥–∞–Ω–∏–π, {cache_info["misses"]} –ø—Ä–æ–º–∞—Ö–æ–≤, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å {cache_info["hit_rate"]*100:.1f}%')
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π: 90 –º–∞—Ç—á–µ–π, 10 –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –Ω–∞ –º–∞—Ç—á

**–ë–µ–∑ –∫–µ—à–∞:**
- 900 –≤—ã–∑–æ–≤–æ–≤ √ó 0.86—Å = **774 —Å–µ–∫—É–Ω–¥—ã** (12.9 –º–∏–Ω—É—Ç)

**–° –∫–µ—à–µ–º:**
- –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤: ~30 (WIN_DRAW_LOSS:–ø1, TOTAL:—Ç–±, –∏ —Ç.–¥.)
- –ü–µ—Ä–≤—ã–µ 30 –≤—ã–∑–æ–≤–æ–≤: 30 √ó 0.86—Å = **25.8 —Å–µ–∫—É–Ω–¥**
- –û—Å—Ç–∞–ª—å–Ω—ã–µ 870 –≤—ã–∑–æ–≤–æ–≤: 870 √ó 0.0001—Å = **0.087 —Å–µ–∫—É–Ω–¥**
- **–ò—Ç–æ–≥–æ: ~26 —Å–µ–∫—É–Ω–¥** –≤–º–µ—Å—Ç–æ 774 —Å–µ–∫—É–Ω–¥
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ: –≤ 30 —Ä–∞–∑!**

### –†–µ–∞–ª—å–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–µ—à–∞

–û–∂–∏–¥–∞–µ—Ç—Å—è **hit rate > 95%** (>95% –∑–∞–ø—Ä–æ—Å–æ–≤ –±—É–¥—É—Ç –∏–∑ –∫–µ—à–∞).

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
```
–ö–µ—à —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: 870 –ø–æ–ø–∞–¥–∞–Ω–∏–π, 30 –ø—Ä–æ–º–∞—Ö–æ–≤, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 96.7%
```

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–µ—à–µ–º

### –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞

```python
from db.queries.statistics_cache import clear_statistics_cache

# –û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
clear_statistics_cache()
```

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–µ—à–µ

```python
from db.queries.statistics_cache import get_cache_info

info = get_cache_info()
print(f"–ü–æ–ø–∞–¥–∞–Ω–∏–π: {info['hits']}")
print(f"–ü—Ä–æ–º–∞—Ö–æ–≤: {info['misses']}")
print(f"–†–∞–∑–º–µ—Ä: {info['currsize']}/{info['maxsize']}")
print(f"–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {info['hit_rate']*100:.1f}%")
```

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

### –ö–æ–≥–¥–∞ –æ—á–∏—â–∞—Ç—å –∫–µ—à

–ö–µ—à –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

–î–ª—è –¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∫–µ—à –Ω—É–∂–Ω–æ –æ—á–∏—â–∞—Ç—å:
- –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `calculation.py` (–æ–±–Ω–æ–≤–∏–ª–∏—Å—å standings/features)
- –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è `processing.py` (—Å–æ–∑–¥–∞–ª–∏—Å—å –Ω–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã)
- –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã `statistics`

### –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏

- –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –∫–µ—à–∞: ~1KB
- –ú–∞–∫—Å–∏–º—É–º: 1024 √ó 1KB = ~1MB
- –ü—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è –ª—é–±–æ–π —Å–∏—Å—Ç–µ–º—ã

## üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `db/queries/statistics_cache.py` | ‚úÖ **–°–û–ó–î–ê–ù** - –º–æ–¥—É–ª—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è |
| `publisher/statistics_publisher.py` | ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à, –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ |
| `publisher/formatters/forecast_formatter.py` | ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à |

## üéØ –ò—Ç–æ–≥

- **–ë—ã–ª–æ:** ~12 –º–∏–Ω—É—Ç (720 —Å–µ–∫—É–Ω–¥)
- **–°—Ç–∞–ª–æ:** ~30 —Å–µ–∫—É–Ω–¥ (—Å —É—á–µ—Ç–æ–º –¥—Ä—É–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** **–≤ 24 —Ä–∞–∑–∞!** üöÄ

